#!/bin/bash

export ENV_ROOT=$(cd `dirname ${BASH_SOURCE[0]}` && pwd)

# Default target root to HOME, can be overridden with --target-root
export TARGET_ROOT="$HOME"

source ${ENV_ROOT}/inc/base.sh
source ${ENV_ROOT}/inc/install.sh
source ${ENV_ROOT}/inc/config.sh
source ${ENV_ROOT}/inc/patch.sh

if [ "$0" = "${BASH_SOURCE[0]}" ]; then
    SHELL_NAME=`ps -p$PPID | tail -1 | awk '{print $NF}' | tr -cd '[:alnum:]/' | xargs basename`
    export SHELL_PATH=$(which $SHELL_NAME)
fi
export SHELL_NAME=`basename ${SHELL_PATH:-bash}`

function print_usage() {
    echo "Usages: $0 [OPTIONS] [COMMAND]"
    echo ""
    echo "OPTIONS:"
    echo "  --target-root <path>  Specify target directory for rc files (default: \$HOME)"
    echo ""
    echo "COMMANDS:"
    echo "  patch        Patch rc files (.bashrc, .vimrc, etc.)"
    echo "  install      Install vim-plug, tmux tpm, fzf"
    echo "  config       Configure git and vim"
    echo "  config-git   Configure git only"
    echo "  config-vim   Configure vim only"
    echo "  all          Run all commands (default)"
    echo ""
    echo "EXAMPLES:"
    echo "  $0                              # Run all commands with default target (~)"
    echo "  $0 --target-root /opt/myenv     # Run all commands targeting /opt/myenv"
    echo "  $0 --target-root /opt/myenv patch  # Only patch rc files in /opt/myenv"
}

function patch() {
    echo 'Patching rc ...'
    patch_rc_files $SHELL_NAME
}

function install() {
    echo 'Installing vim/tmux_tpm/fzf ...'
    install_vim_plug
    install_tmux_tpm
    install_fzf
}

function config_git() {
    echo 'Configuring git ...'
    config_git_vim_diff
    config_git_core_editor
    config_git_cache_timeout
}

function config_vim() {
    echo 'Configuring vim ...'
    config_vim_plug
}

function config() {
    config_git
    config_vim
}

function default_action() {
    patch
    install
    config
}

# Parse arguments
COMMANDS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --target-root)
            if [ -z "$2" ]; then
                echo "Error: --target-root requires a path argument"
                print_usage
                exit 1
            fi
            export TARGET_ROOT="$2"
            # Create target directory if it doesn't exist
            mkdir -p "$TARGET_ROOT"
            shift 2
            ;;
        -h|--help|--usage|-H)
            print_usage
            exit 0
            ;;
        patch|install|config|config-git|config-vim|all)
            COMMANDS+=("$1")
            shift
            ;;
        *)
            echo "Unknown option or command: $1"
            print_usage
            exit 1
            ;;
    esac
done

# If no commands specified, run default action
if [ ${#COMMANDS[@]} -eq 0 ]; then
    default_action
    exit 0
fi

# Execute commands
for cmd in "${COMMANDS[@]}"; do
    case "$cmd" in
        patch)
            patch;;
        install)
            install;;
        config)
            config;;
        config-git)
            config_git;;
        config-vim)
            config_vim;;
        all)
            default_action;;
    esac
done
